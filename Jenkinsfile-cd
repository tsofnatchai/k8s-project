pipeline {
    agent any

    environment {
        KUBECONFIG = "/var/lib/jenkins/.kube/config"
        HELM_RELEASE_NAME = "rabbitmq"
        HELM_CHART_REPO = "https://charts.bitnami.com/bitnami"
        HELM_CHART_NAME = "bitnami/rabbitmq"
        HELM_VALUES_FILE = "values.yaml"  // Optional if using custom values
    }

    stages {
        stage('Add Helm Repo & Update') {
            steps {
                script {
                    sh 'helm repo add bitnami https://charts.bitnami.com/bitnami'
                    sh 'helm repo update'
                }
            }
        }

        stage('Deploy RabbitMQ with Helm') {
            steps {
                script {
                    sh "helm upgrade --install ${HELM_RELEASE_NAME} ${HELM_CHART_NAME} --values ${HELM_VALUES_FILE}"
                }
            }
        }
    }

    post {
        success {
            echo 'RabbitMQ Deployment Successful!'
        }
        failure {
            echo 'Deployment Failed. Check logs for details.'
        }
    }
}
